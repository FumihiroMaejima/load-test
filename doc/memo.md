
# 負荷試験の基礎

## 負荷試験の目的

## オンプレミス時代の負荷試験の目的

1. 各種ユースケースを特定し、それぞれにおけるシステムの応答性能を推測する。
2. 高負荷時のシステムの性能改善を行う。
3. 目的の性能を提供する為に必要なハードウェアを予め選定する。

## クラウド時代の負荷試験の目的

1. 各種ユースケースを特定し、それぞれにおけるシステムの応答性能を推測する。
2. 高負荷時のシステムの性能改善を行う。
3. 目的の性能を提供する為に必要なハードウェアを予め選定する。
4. システムがスケール性能を持つこと確認する。
5. システムのスケール特性を把握する。


- [] いくつかのスループットのレベル(例: 100rps, 500rps, 1000rps, 2000rps, 5000rps...)
- [] 実際にこのWebシステムは目標値を超えて、最大どの程度のスループットを処理出来るか。

---

### スループット

単位時間に処理を行う量のこと。
webシステムでは、「１秒間に処理を行う(捌ける)HTTPリクエストの数」を基準にすることが多い。(rps(Request Per Second)と言う単位)

「ネットワーク上を流れるデータ転送速度」の事を言うこともある。
このスループットをネットワーク帯域、最大スループットをネットワーク帯域幅と呼ぶ。

---

### レイテンシ

処理時間のこと。
該当システムにおいて、(平均)応答時間が1秒から0.1秒に短縮
リクエストからレスポンスまでかかった時間

試験実施時には目標設定として、下記の通り表記する

スループット:**rps
レイテンシ:n秒以下


---

### 可用性(アベイラビリティ)

システムやサービスが正常に提供出来る状態のこと。
可用性99.92%が99.92%の時間正常に利用出来ると言うことになる。
1年間当たり何分間サービスがダウンしているかが目安となる。

### 単一障害点と冗長化

・単一障害点:故障するとサービスが提供出来なくなる箇所
・冗長化:単一障害点をなくすこと

### スケーラビリティ
負荷の増大に応じてどれだけ柔軟に性能や機能を向上・拡張出来るかを示す。

1. スケールアウト：マシンの台数を増やすことで性能向上をはかる。
2. スケールイン：マシンそのもののスペックを上げることで性能向上をはかる。
3. スケールダウン：マシンそのもののスペックを下げることでコストダウンをはかる。

---

# 負荷試験の作業手順

1. スケジュールを決める
2. 目標の設定:レイテンシ
3. 目標の設定:スループット

まず一定時間位にどの程度アクセスがあるかを把握すること

```shell
- 1日の利用人数(人/日) × 1人あたりの1日の平均アクセス数(回/人) = 1日の総アクセス数(回/日)
- 1日の総アクセス数(回/日) ÷ 1日の秒数86,400(秒/日) = 1日の平均rps(回/秒)
- 1日の平均rps(回/秒) × 1日の平均アクセス数に対する最大ピーク時の倍率 = 最大rps(回/秒)
```

4. 負荷試験のシナリオ作成
5. 試験の実施

下記の値をモニタリングする

| サブシステム | 確認箇所 |
| :--- | :--- |
| ネットワーク | 転送量 |
| ハードウェア、OS | CPU,メモリ,プロセス数,SWAP,Load Average |
| TCP | 外部へのコネクション状況（ESTABLISH や FIN WAIT など） |
| ディスク | IOPS, R/W 転送データ量 |
| サーバミドルウェア（Apache, MySQL） | コネクション数 |
| アプリケーション | プロファイラーにて監視 |
| MySQL | Slow Query, Process List |


サーバーにログインして下記のコマンドで試験中のリソースも監視する

- top, htop：CPU、メモリ使用量等
- netstas, ss：TCPコネクション数
- vmstat, dstat：1秒毎に実行して、リソース状況の記録

6. 結果の確認
7. チューニング
8. 試験とチューニングの繰り返し
9. レポート作成

---


## システム性能改善の基礎知識

### スループットの改善

### レイテンシの改善



---

## 良い負荷試験が実施されている事を示す指標

1. 負荷試験対象システムに負荷が集中している状態
2. ボトルネック部分が特定出来ている状態

---

| 名前 | バージョン |
| :--- | :---: |
| PHP | 8.1.9(php:8.1.9-fpm-alpine) |
| MySQL | 5.7 |
| Nginx | 1.23(nginx:1.23-alpine) |
| Laravel | 9.* |

[backend/README](./app/backend/README.md)

---

# 負荷試験実施の9つのステップ


| 負荷試験のステップ | 負荷試験対象 | ボトルネックが生じやすい場所 |
| :--- | :---: | :--- |
| step1: ツールや環境の検証 | 静的ページ | 攻撃ツール/ネットワーク |
| step2: Webフレームワークの検証 | Webフレームワークを利用したテストページ | 攻撃ツール/Webサーバー |
| step3: 参照系性能検証 | 参照系ページ/API | 攻撃ツール/Webサーバー/キャッシュサーバー/DBサーバー |
| step4: 更新系性能検証 | 更新系ページ/API | 攻撃ツール/Webサーバー/DBサーバー |
| step5: 外部サービス連携性能検証 | 外部サービス連携ページ/API | 攻撃ツール/ネットワーク/外部サービス |
| step6: シナリオ試験 | 全体 | Webサーバー/DBサーバー |
| step7: スケールアウト試験準備 | 全体 | ロードバランサー |
| step8: スケールアップ/アウト試験 | ステップ1~6までの回帰 | 攻撃ツール/ネットワーク/Webサーバー/キャッシュサーバー/DBサーバー/外部サービス/ロードバランサー |
| step9: 限界性能試験 | ステップ1~6までの回帰 | 攻撃ツール/ネットワーク/Webサーバー/キャッシュサーバー/DBサーバー/外部サービス/ロードバランサー |


## 攻撃ツールのボトルネックの原因と対策

| 原因区分 | 原因詳細 | 主な症状 | 対策 |
| :--- | :---: |  :---: | :--- |
| サーバー/攻撃ツールの設定不備 | ファイルディスクリプタが不足する | 試験開始後しばらくして通信に失敗し始める | ファイルディスクリプタ設定の見直しを行う |
| 攻撃シナリオ不備 | 参照・更新先のリソースが同一のリソースに集中している | DBの特定のレコードに処理が集中する | ユーザーを分散させるシナリオに変更する |
| 攻撃サーバー能力不足 | CPU/メモリ/ネットワークリソース不足 |  | 攻撃サーバーのスケールアップ、攻撃サーバーのスケールアウト、攻撃ツールの見直しを実施 |
| 攻撃サーバー設置ネットワーク不備 | ネットワーク帯域/速度不足 | レイテンシが大きくなり、対象システムに負荷がかからない | 近いネットワークから攻撃する |

---

## Webサーバーボトルネックの原因と対策

| 原因区分 | 原因詳細 | 主な症状 | 対策 |
| :--- | :---: |  :---: | :--- |
| ミドルウェアの設定不備 | HTTPサーバーの不要な機能を利用している。<br>HTTPサーバーの起動パラメーター不備。<br>出力データサイズネットワークを圧迫する。<br>Webアクセラレーターを利用していない<br>利用プログラミング言語のバージョンが古い | <br><br>サーバーからのOutboundスループットが増える。<br>WebサーバーのCPUリソースが100%近くで張り付く | 不要な機能を利用しない様にする。<br>MaxClient設定の見直しやprefork設定の見直しなど<br>ファイル圧縮転送(mod_deflate)などを検討する,CDNの利用を検討する<br>PHPの場合はOPcacheなどのアクセラレーターの利用を検討する<br>言語のバージョンアップを検討する。 |
| Webフレームワークの問題があるケース | フレームワークそのものが重厚で重い<br>フレームワークの無駄な機能を利用している |  | フレームワークの見直し<br>不要な機能を利用しない様にする |
| アプリケーションの不備 | デバッグモードで動作している<br>アプリケーションの無駄が多い<br>ランダムなファイルI/Oが発声 | WebサーバーのCPUリソース中のsys利用割合が増える | ローカルファイルシステム上でセッションを利用している場合などに発生 |
| サーバーリソース不足 | WebサーバーのCPUリソースが100%近くで張り付く | 正しく処理が行われているなら問題なし。<br>スケールアップする。<br>スケールアウトする。 |  |

---

## topの実行結果例

```shell
# top
Mem: 1759200K used, 6383056K free, 330104K shrd, 50456K buff, 764248K cached
CPU:   0% usr   0% sys   0% nic  99% idle   0% io   0% irq   0% sirq
Load average: 0.01 0.04 0.02 2/649 53
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
   31     1 nginx    S     6720   0%   1   0% nginx: worker process
   32     1 nginx    S     6720   0%   2   0% nginx: worker process
   34     1 nginx    S     6720   0%   1   0% nginx: worker process
   33     1 nginx    S     6720   0%   3   0% nginx: worker process
    1     0 root     S     6272   0%   2   0% nginx: master process nginx -g daemon off; -c /etc/nginx/nginx.conf
   44     0 root     S     1772   0%   3   0% ash
   35     0 root     S     1744   0%   2   0% ash
```

## netstatの実行結果例

```shell
# netstat
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 d10be59bfbdf:http       172.19.0.1:60182        ESTABLISHED
tcp        0      0 d10be59bfbdf:http       172.19.0.1:62892        TIME_WAIT
Active UNIX domain sockets (w/o servers)
Proto RefCnt Flags       Type       State         I-Node Path
unix  3      [ ]         STREAM     CONNECTED      23091
unix  3      [ ]         STREAM     CONNECTED      23092
unix  3      [ ]         STREAM     CONNECTED      23094
unix  3      [ ]         STREAM     CONNECTED      23095
unix  3      [ ]         STREAM     CONNECTED      23093
unix  3      [ ]         STREAM     CONNECTED      23096
unix  3      [ ]         STREAM     CONNECTED      23097
unix  3      [ ]         STREAM     CONNECTED      23098
```


---

