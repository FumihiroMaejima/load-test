
# 負荷試験の基礎

## 負荷試験の目的

## オンプレミス時代の負荷試験の目的

1. 各種ユースケースを特定し、それぞれにおけるシステムの応答性能を推測する。
2. 高負荷時のシステムの性能改善を行う。
3. 目的の性能を提供する為に必要なハードウェアを予め選定する。

## クラウド時代の負荷試験の目的

1. 各種ユースケースを特定し、それぞれにおけるシステムの応答性能を推測する。
2. 高負荷時のシステムの性能改善を行う。
3. 目的の性能を提供する為に必要なハードウェアを予め選定する。
4. システムがスケール性能を持つこと確認する。
5. システムのスケール特性を把握する。


- [] いくつかのスループットのレベル(例: 100rps, 500rps, 1000rps, 2000rps, 5000rps...)
- [] 実際にこのWebシステムは目標値を超えて、最大どの程度のスループットを処理出来るか。

---

### スループット

単位時間に処理を行う量のこと。
webシステムでは、「１秒間に処理を行うHTTPリクエストの数」を基準にすることが多い。(rps(Request Per Second)と言う単位)

「ネットワーク上を流れるデータ転送速度」の事を言うこともある。
このスループットをネットワーク帯域、最大スループットをネットワーク帯域幅と呼ぶ。

---

### レイテンシ

処理時間のこと。
該当システムにおいて、(平均)応答時間が1秒から0.1秒に短縮


---


## システム性能改善の基礎知識

### スループットの改善

### レイテンシの改善



---

## 良い負荷試験が実施されている事を示す指標

1. 負荷試験対象システムに負荷が集中している状態
2. ボトルネック部分が特定出来ている状態

---

| 名前 | バージョン |
| :--- | :---: |
| PHP | 8.1.9(php:8.1.9-fpm-alpine) |
| MySQL | 5.7 |
| Nginx | 1.23(nginx:1.23-alpine) |
| Laravel | 9.* |

[backend/README](./app/backend/README.md)

---

# 負荷試験実施の9つのステップ


| 負荷試験のステップ | 負荷試験対象 | ボトルネックが生じやすい場所 |
| :--- | :---: | :--- |
| step1: ツールや環境の検証 | 静的ページ | 攻撃ツール/ネットワーク |
| step2: Webフレームワークの検証 | Webフレームワークを利用したテストページ | 攻撃ツール/Webサーバー |
| step3: 参照系性能検証 | 参照系ページ/API | 攻撃ツール/Webサーバー/キャッシュサーバー/DBサーバー |
| step4: 更新系性能検証 | 更新系ページ/API | 攻撃ツール/Webサーバー/DBサーバー |
| step5: 外部サービス連携性能検証 | 外部サービス連携ページ/API | 攻撃ツール/ネットワーク/外部サービス |
| step6: シナリオ試験 | 全体 | Webサーバー/DBサーバー |
| step7: スケールアウト試験準備 | 全体 | ロードバランサー |
| step8: スケールアップ/アウト試験 | ステップ1~6までの回帰 | 攻撃ツール/ネットワーク/Webサーバー/キャッシュサーバー/DBサーバー/外部サービス/ロードバランサー |
| step9: 限界性能試験 | ステップ1~6までの回帰 | 攻撃ツール/ネットワーク/Webサーバー/キャッシュサーバー/DBサーバー/外部サービス/ロードバランサー |


## 攻撃ツールのボトルネックの原因と対策

| 原因区分 | 原因詳細 | 主な症状 | 対策 |
| :--- | :---: |  :---: | :--- |
| サーバー/攻撃ツールの設定不備 | ファイルディスクリプタが不足する | 試験開始後しばらくして通信に失敗し始める | ファイルディスクリプタ設定の見直しを行う |
| 攻撃シナリオ不備 | 参照・更新先のリソースが同一のリソースに集中している | DBの特定のレコードに処理が集中する | ユーザーを分散させるシナリオに変更する |
| 攻撃サーバー能力不足 | CPU/メモリ/ネットワークリソース不足 |  | 攻撃サーバーのスケールアップ、攻撃サーバーのスケールアウト、攻撃ツールの見直しを実施 |
| 攻撃サーバー設置ネットワーク不備 | ネットワーク帯域/速度不足 | レイテンシが大きくなり、対象システムに負荷がかからない | 近いネットワークから攻撃する |

---

## Webサーバーボトルネックの原因と対策

| 原因区分 | 原因詳細 | 主な症状 | 対策 |
| :--- | :---: |  :---: | :--- |
| ミドルウェアの設定不備 | HTTPサーバーの不要な機能を利用している。<br>HTTPサーバーの起動パラメーター不備。<br>出力データサイズネットワークを圧迫する。<br>Webアクセラレーターを利用していない<br>利用プログラミング言語のバージョンが古い | <br><br>サーバーからのOutboundスループットが増える。<br>WebサーバーのCPUリソースが100%近くで張り付く | 不要な機能を利用しない様にする。<br>MaxClient設定の見直しやprefork設定の見直しなど<br>ファイル圧縮転送(mod_deflate)などを検討する,CDNの利用を検討する<br>PHPの場合はOPcacheなどのアクセラレーターの利用を検討する<br>言語のバージョンアップを検討する。 |
| Webフレームワークの問題があるケース | フレームワークそのものが重厚で重い<br>フレームワークの無駄な機能を利用している |  | フレームワークの見直し<br>不要な機能を利用しない様にする |
| アプリケーションの不備 | デバッグモードで動作している<br>アプリケーションの無駄が多い<br>ランダムなファイルI/Oが発声 | WebサーバーのCPUリソース中のsys利用割合が増える | ローカルファイルシステム上でセッションを利用している場合などに発生 |
| サーバーリソース不足 | WebサーバーのCPUリソースが100%近くで張り付く | 正しく処理が行われているなら問題なし。<br>スケールアップする。<br>スケールアウトする。 |  |

---

## volumeとnetworkの作成

networkは`gateway`と`subnet`を必ず指定する。(値は任意。)

```shell
docker volume create ${PROJECT_NAME}-db-store
docker volume create ${PROJECT_NAME}-redis-store
docker volume create ${PROJECT_NAME}-mail-store
docker network create --gateway=172.19.0.1 --subnet=172.19.0.0/16 ${PROJECT_NAME}-net
```


---

